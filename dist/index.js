"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var os=require("os"),path=_interopDefault(require("path")),fs=_interopDefault(require("fs")),yargs=_interopDefault(require("yargs")),semver=_interopDefault(require("semver")),rimraf=_interopDefault(require("rimraf")),notifier=_interopDefault(require("node-notifier")),htmlWebpackPluginBeforeHtmlGeneration=function(e){var n=e.filenameMark;return function(i,t){var r=i.assets,o=r.js,s=void 0===o?[]:o,a=r.css,c=void 0===a?[]:a;i.assets.js=s.map(function(i){var t="/"+e.newVersion+i;return-1!==t.indexOf(e.newVersion)?i:n?t.replace(n,e.newVersion):"/"+e.newVersion+i}),i.assets.css=c.map(function(i){var t="/"+e.newVersion+i;return-1!==t.indexOf(e.newVersion)?i:n?t.replace(n,e.newVersion):t}),t()}},htmlWebpackPluginAfterHtmlProcessing=function(e){var n=e.inspectContent;return function(i,t){if(n){var r="\x3c!-- "+e.banner+" --\x3e";i.html=r+os.EOL+i.html}t(null,i)}},classCallCheck=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")},WebpackAutoVersionPlugin=function e(){var n=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,e),this.init=function(){n.pkgPath=n.webpackConfig.context+"/package.json",n.pkg=n.readJsonFile(n.pkgPath),n.fixPackageFile(),n.autoIncreaseVersion(),n.banner=n.copyright+" version "+n.newVersion+"   "+(new Date).toLocaleString()},this.fixPackageFile=function(){n.pkg.version||(n.pkg.version="0.0.1")},this.readJsonFile=function(e){var n=fs.readFileSync(e);return JSON.parse(n)},this.injectContent=function(e){if(n.inspectContent){var i=e.source();"string"==typeof i&&(e.source=function(){return i.replace(n.template,n.newVersion)})}},this.cleanupOldVersion=function(){if(n.cleanup){var e=n.webpackConfig.output.path;fs.readdirSync(e).filter(function(n){return fs.statSync(e+"/"+n).isDirectory}).forEach(function(i){semver.valid(i)&&semver.lt(i,n.pkg.version)&&rimraf(e+"/"+i,function(e){notifier.notify({title:"清除旧版本出错",message:e.message})})})}},this.autoIncreaseVersion=function(){var e=yargs.argv._,i=n.pkg.version,t=-1!==e.indexOf("minor"),r=-1!==e.indexOf("major");return t?(n.newVersion=semver.inc(i,"minor"),void(n.pkg.version=n.newVersion)):r?(n.newVersion=semver.inc(i,"major"),void(n.pkg.version=n.newVersion)):(n.newVersion=semver.inc(i,"patch"),void(n.pkg.version=n.newVersion))},this.persistVersion=function(){var e=JSON.stringify(n.pkg,null,n.space);fs.writeFileSync(n.pkgPath,e)},this.injectJs=function(e){var i="/**  "+n.banner+"*/"+os.EOL+e.source();e.source=function(){return i}},this.injectCss=function(e){var i="/**  "+n.banner+"   */"+os.EOL+e.source();e.source=function(){return i}},this.injectHtml=function(e){var i="\x3c!--  "+n.banner+"   --\x3e"+os.EOL+e.source();e.source=function(){return i}},this.replaceVersionTag=function(e){return n.filenameMark?e.replace(n.filenameMark,"v"+n.pkg.version):e},this.apply=function(e){var i=n;n.webpackConfig=e.options,n.init();var t=n.pkg.version;e.plugin("emit",function(e,n){var r={};Object.keys(e.assets).forEach(function(n){var o=path.extname(n),s=e.assets[n];i.injectContent(s);var a=i.replaceVersionTag(n);switch(o){case".js":r[t+"/"+a]=s,i.injectJs(s);break;case".css":r[t+"/"+a]=s,i.injectCss(s);break;default:-1!==i.ignoreSuffix.indexOf(o)?(r[a]=s,i.injectHtml(s)):r[t+"/"+a]=s}}),e.assets=r,e.chunks.forEach(function(e){e.files=e.files.filter(function(e){return".html"!==path.extname(e)}).map(function(e){return t+"/"+i.replaceVersionTag(e)}).concat(e.files.filter(function(e){return".html"===path.extname(e)}))}),n()}),e.plugin("failed",function(e){console.log("fail"),notifier.notify({title:"WebpackAutoVersionPlugin",message:e.message})}),e.plugin("done",function(){i.cleanupOldVersion(),i.persistVersion()}),e.hooks?e.hooks.compilation.tap("WebpackAutoVersionPlugin",function(e){e.hooks.htmlWebpackPluginBeforeHtmlGeneration.tapAsync("WebpackAutoVersionPlugin",htmlWebpackPluginBeforeHtmlGeneration(n)),e.hooks.htmlWebpackPluginAfterHtmlProcessing.tapAsync("WebpackAutoVersionPlugin",htmlWebpackPluginAfterHtmlProcessing(n))}):e.plugin("compilation",function(e){e.plugin("html-webpack-plugin-before-html-generation",htmlWebpackPluginBeforeHtmlGeneration(n)),e.plugin("html-webpack-plugin-after-html-processing",htmlWebpackPluginAfterHtmlProcessing(n))})},this.filenameMark=i.filenameMark,this.copyright=i.copyright||"VERSION",this.pkgPath="",this.pkg="",this.space=i.space||2,this.cleanup=i.cleanup||!1,this.inspectContent=i.inspectContent||!0,this.template=i.template||"["+this.copyright+"]version[/"+this.copyright+"]",this.ignoreSuffix=i.ignoreSuffix||[".html"]};module.exports=WebpackAutoVersionPlugin;
